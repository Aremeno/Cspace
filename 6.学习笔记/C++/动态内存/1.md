# 动态内存

C++程序中的内存分为两部分：

- **栈内存（stack）**：由编译器自动分配和释放，存储局部变量和函数调用信息。栈内存的分配和释放速度较快，但空间有限。
- **堆内存（heap）**：由程序员手动分配和释放，适用于需要动态分配内存的场景。堆内存的分配和释放速度较慢，但空间较大。

## 动态内存分配

在C++中，动态内存分配使用`new`运算符。`new`运算符用于在堆上分配内存，并返回指向该内存的指针。

```cpp
int* p = NULL; // 初始化指针
p = new int; // 在堆上分配一个整数的内存
```

### 检查分配是否成功

在使用`new`分配内存后，应该检查指针是否为`NULL`，以确保内存分配成功。

```cpp
double* pd = new double; // 分配一个double类型的内存
if ( pd == NULL ) {
    // 处理内存分配失败的情况
    std::cout << "Memory allocation failed!" << std::endl;
    exit(1);
}
```

**注意**：malloc()函数在C++中不推荐使用，建议使用`new`运算符进行内存分配。

## 动态内存释放

使用`new`分配的内存需要使用`delete`运算符进行释放，以避免内存泄漏。

```cpp
delete p; // 释放之前分配的整数内存
p = NULL; // 将指针置为NULL，防止悬空指针
```

## 动态数组

动态数组可以使用`new`运算符分配一块连续的内存空间，用于存储多个元素。

```cpp
int *array = new int[10]; // 分配一个包含10个整数的动态数组

delete[] array; // 释放动态数组内存
```

**二维动态数组**可以通过指针数组实现：

```cpp
int **array = new int *[rows];  // 分配行指针数组
for (int i = 0; i < rows; i++) {
    array[i] = new int[cols]; // 为每一行分配列数组
}

for (int i = 0; i < rows; i++) {
    delete[] array[i]; // 释放每一行的列数组
}
delete[] array; // 释放行指针数组
array = NULL; // 防止悬空指针
```

## 对象的动态分配

动态分配对象与基本数据类型类似，使用`new`运算符分配内存，并调用构造函数初始化对象。

```cpp
#include <iostream>
using namespace std;

class Box {
    public:
        Box() {
            cout << "调用构造函数" << endl;
        }
        ~Box() {
            cout << "调用析构函数" << endl;
        }
};

int main() {
    Box* myBox = new Box[5]; // 动态分配5个Box对象
    delete[] myBox; // 释放动态分配的Box对象
    return 0;
}
```

在上面的例子中，`new Box[5]`动态分配了5个`Box`对象，并调用了它们的构造函数。使用`delete[]`释放内存时，会依次调用每个对象的析构函数，确保资源正确释放。